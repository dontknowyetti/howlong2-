<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>How Long Is The Line?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 18px;
      padding: 18px 18px 22px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      border: 1px solid #1e293b;
      touch-action: pan-y; /* allow vertical scroll but we handle horizontal swipe */
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .store {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .pill {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      color: #bfdbfe;
      background: rgba(37, 99, 235, 0.12);
    }

    .layout-summary {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    /* Lane switcher */
    .lane-switcher {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      margin-bottom: 10px;
    }

    .lane-chip {
      font-size: 0.75rem;
      padding: 5px 9px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease;
      white-space: nowrap;
    }

    .lane-chip.active {
      background: rgba(37, 99, 235, 0.18);
      color: #e5e7eb;
    }

    /* Status card */
    .status-card {
      border-radius: 14px;
      padding: 12px 12px 14px;
      margin-bottom: 14px;
      background: radial-gradient(circle at top left, #1d2535, #020617);
      border: 1px solid #1f2937;
    }

    .status-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .status-value {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .dot-none { background: #22c55e; }
    .dot-short { background: #a3e635; }
    .dot-medium { background: #eab308; }
    .dot-long { background: #f97316; }

    /* Progress bar */
    .progress-wrapper {
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .progress-track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transition: width 0.18s ease;
    }

    .fill-none { background: #22c55e; }
    .fill-short { background: #a3e635; }
    .fill-medium { background: #eab308; }
    .fill-long { background: #f97316; }

    .meta {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.78rem;
      color: #6b7280;
    }

    /* Reset button */
    .reset-btn {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.12s ease, border 0.12s ease;
    }

    .reset-btn:hover {
      background: #1e293b;
      border-color: #334155;
    }

    .reset-btn:active {
      transform: scale(0.98);
    }

    /* Section buttons */
    .sections {
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .section-btn {
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      cursor: pointer;
      transition: border 0.12s ease, background 0.12s ease, transform 0.05s ease;
    }

    .section-btn .label {
      font-weight: 600;
      font-size: 0.82rem;
    }

    .section-btn .sub {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .section-btn:hover {
      border-color: #4b5563;
      background: #030712;
    }

    .section-btn:active {
      transform: scale(0.98);
    }

    .section-btn.selected {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.16);
    }

    .hint {
      font-size: 0.75rem;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .app { padding: 16px; border-radius: 16px; }
      .lane-switcher { width: 100%; justify-content: space-between; }
      .lane-chip { flex: 1; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="app" id="app-root">
    <header class="app-header">
      <div>
        <div class="title">How long is the line?</div>
        <div class="store" id="store-name">ALDI Selly Oak</div>
      </div>
      <div class="pill">Live check-in</div>
    </header>

    <div class="layout-summary" id="layout-summary">
      Manned tills: 6 · Self-checkouts: 2
    </div>

    <div class="lane-switcher" id="lane-switcher">
      <button class="lane-chip active" data-lane="tills">Main tills</button>
      <button class="lane-chip" data-lane="sco1">Self-checkout 1</button>
      <button class="lane-chip" data-lane="sco2">Self-checkout 2</button>
    </div>

    <section class="status-card">
      <div class="status-label" id="lane-label">Current report · Main tills</div>
      <div class="status-value">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">No reports yet</span>
      </div>

      <div class="progress-wrapper">
        <div class="progress-track">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <div class="meta">
        <span id="last-updated">Last updated: —</span>
        <span id="local-only">Local votes on this device</span>
      </div>
    </section>

    <button id="reset-btn" class="reset-btn">Reset this lane</button>

    <section class="sections" id="sections">
      <!-- Buttons injected by JS -->
    </section>

    <p class="hint">
      Swipe left/right to switch lanes.  
      Tap a section to report. Bar = average of your taps for that lane.
    </p>
  </div>

  <script>
    // Store + lanes
    const STORE_CONFIG = {
      id: "aldi_selly_oak",
      name: "ALDI Selly Oak",
      mannedTills: 6,
      selfCheckouts: 2,
      lanes: [
        { id: "tills", label: "Main tills" },
        { id: "sco1", label: "Self-checkout 1" },
        { id: "sco2", label: "Self-checkout 2" }
      ]
    };

    // Per-lane sections
    const SECTION_CONFIG = {
      tills: [
        { id: "none",   label: "No queue",             description: "Walk straight up",       fill: 5,   intensity: "none" },
        { id: "front",  label: "Front of aisle",       description: "Just into aisle",        fill: 25,  intensity: "short" },
        { id: "middle", label: "Middle of aisle",      description: "Halfway down",           fill: 50,  intensity: "medium" },
        { id: "back",   label: "Back of aisle",        description: "Near end",               fill: 75,  intensity: "long" },
        { id: "beyond", label: "Beyond aisle",         description: "Wrapped / outside",      fill: 100, intensity: "long" }
      ],
      sco1: [
        { id: "sco_full",   label: "Packed / long wait",        description: "All machines busy",       fill: 100, intensity: "long" },
        { id: "sco_tight",  label: "No spaces, 1–3 waiting",    description: "Small queue",             fill: 70,  intensity: "medium" },
        { id: "sco_some",   label: "1–2 spaces free",           description: "Probably get one soon",   fill: 40,  intensity: "short" },
        { id: "sco_plenty", label: "3+ spaces free",            description: "Plenty of machines",      fill: 15,  intensity: "none" }
      ],
      sco2: [
        { id: "sco_full",   label: "Packed / long wait",        description: "All machines busy",       fill: 100, intensity: "long" },
        { id: "sco_tight",  label: "No spaces, 1–3 waiting",    description: "Small queue",             fill: 70,  intensity: "medium" },
        { id: "sco_some",   label: "1–2 spaces free",           description: "Probably get one soon",   fill: 40,  intensity: "short" },
        { id: "sco_plenty", label: "3+ spaces free",            description: "Plenty of machines",      fill: 15,  intensity: "none" }
      ]
    };

    const STORAGE_PREFIX = "queue_section_" + STORE_CONFIG.id + "_";
    let currentLaneId = "tills";

    const laneStorageKey = laneId => STORAGE_PREFIX + laneId;

    function loadStatus(laneId) {
      try {
        const raw = localStorage.getItem(laneStorageKey(laneId));
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj.votes) obj.votes = {};
        return obj;
      } catch {
        return null;
      }
    }

    function registerVote(laneId, sectionId) {
      const key = laneStorageKey(laneId);
      let record = loadStatus(laneId) || { votes: {} };
      record.votes[sectionId] = (record.votes[sectionId] || 0) + 1;
      record.updatedAt = new Date().toISOString();
      localStorage.setItem(key, JSON.stringify(record));
      return record;
    }

    function resetLane(laneId) {
      localStorage.removeItem(laneStorageKey(laneId));
      applyStatusToUI(laneId);
    }

    function formatTimeAgo(iso) {
      if (!iso) return "Last updated: —";
      const t = new Date(iso);
      const diffMin = Math.floor((new Date() - t) / 60000);
      if (diffMin < 1) return "Last updated: just now";
      if (diffMin < 60) return `Last updated: ${diffMin} minutes ago`;
      const diffH = Math.floor(diffMin / 60);
      if (diffH < 24) return `Last updated: ${diffH} hours ago`;
      const diffD = Math.floor(diffH / 24);
      return `Last updated: ${diffD} days ago`;
    }

    function getSectionsForLane(laneId) {
      return SECTION_CONFIG[laneId] || SECTION_CONFIG["tills"];
    }

    function renderSectionsForLane(laneId) {
      const box = document.getElementById("sections");
      box.innerHTML = "";
      getSectionsForLane(laneId).forEach(section => {
        const btn = document.createElement("button");
        btn.className = "section-btn";
        btn.dataset.section = section.id;
        btn.innerHTML = `
          <span class="label">${section.label}</span>
          <span class="sub">${section.description}</span>
        `;
        btn.addEventListener("click", () => {
          registerVote(currentLaneId, section.id);
          applyStatusToUI(currentLaneId);
        });
        box.appendChild(btn);
      });
    }

    function applyStatusToUI(laneId) {
      const record = loadStatus(laneId);
      const dot = document.getElementById("status-dot");
      const text = document.getElementById("status-text");
      const fillBar = document.getElementById("progress-fill");
      const updated = document.getElementById("last-updated");
      const label = document.getElementById("lane-label");

      const lane = STORE_CONFIG.lanes.find(l => l.id === laneId);
      label.textContent = `Current report · ${lane.label}`;

      // reset visuals
      dot.className = "dot";
      fillBar.className = "progress-fill";
      fillBar.style.width = "0%";
      document.querySelectorAll(".section-btn").forEach(b => b.classList.remove("selected"));

      if (!record || !record.votes) {
        text.textContent = "No reports yet";
        updated.textContent = "Last updated: —";
        return;
      }

      const sections = getSectionsForLane(laneId);

      let totalVotes = 0;
      let weightedFill = 0;
      let topSection = null;
      let topCount = 0;

      for (const s of sections) {
        const count = record.votes[s.id] || 0;
        if (count > 0) {
          totalVotes += count;
          weightedFill += count * s.fill;
          if (count > topCount) {
            topCount = count;
            topSection = s;
          }
        }
      }

      if (totalVotes === 0) {
        text.textContent = "No reports yet";
        updated.textContent = "Last updated: —";
        return;
      }

      const avgFill = weightedFill / totalVotes;

      // Closest section to average for label + colour
      let closest = sections[0];
      let bestDiff = Math.abs(sections[0].fill - avgFill);
      for (const s of sections) {
        const diff = Math.abs(s.fill - avgFill);
        if (diff < bestDiff) {
          bestDiff = diff;
          closest = s;
        }
      }

      text.textContent =
        laneId === "tills"
          ? `Queue around: ${closest.label} (${totalVotes} reports)`
          : `Self-checkout: ${closest.label} (${totalVotes} reports)`;

      dot.classList.add("dot-" + closest.intensity);
      fillBar.classList.add("fill-" + closest.intensity);
      fillBar.style.width = `${Math.max(0, Math.min(100, avgFill))}%`;

      updated.textContent = formatTimeAgo(record.updatedAt);

      if (topSection) {
        const topBtn = document.querySelector(
          `.section-btn[data-section="${topSection.id}"]`
        );
        if (topBtn) topBtn.classList.add("selected");
      }
    }

    function switchLane(laneId) {
      currentLaneId = laneId;

      document.querySelectorAll(".lane-chip").forEach(chip =>
        chip.classList.toggle("active", chip.dataset.lane === laneId)
      );

      renderSectionsForLane(laneId);
      applyStatusToUI(laneId);
    }

    // --- Swipe handling (left/right to change lane) ---
    let touchStartX = null;
    let touchStartY = null;
    const SWIPE_THRESHOLD = 40; // px

    function handleTouchStart(e) {
      if (!e.touches || e.touches.length === 0) return;
      const t = e.touches[0];
      touchStartX = t.clientX;
      touchStartY = t.clientY;
    }

    function handleTouchEnd(e) {
      if (touchStartX === null || touchStartY === null) return;
      if (!e.changedTouches || e.changedTouches.length === 0) return;

      const t = e.changedTouches[0];
      const dx = t.clientX - touchStartX;
      const dy = t.clientY - touchStartY;

      // Only treat as horizontal swipe if mostly horizontal and big enough
      if (Math.abs(dx) > SWIPE_THRESHOLD && Math.abs(dx) > Math.abs(dy)) {
        if (dx < 0) {
          // swipe left -> next lane
          changeLaneByOffset(1);
        } else {
          // swipe right -> previous lane
          changeLaneByOffset(-1);
        }
      }

      touchStartX = null;
      touchStartY = null;
    }

    function changeLaneByOffset(offset) {
      const lanes = STORE_CONFIG.lanes;
      const currentIndex = lanes.findIndex(l => l.id === currentLaneId);
      if (currentIndex === -1) return;
      const newIndex = (currentIndex + offset + lanes.length) % lanes.length;
      const newLaneId = lanes[newIndex].id;
      switchLane(newLaneId);
    }

    function init() {
      document.getElementById("store-name").textContent = STORE_CONFIG.name;
      document.getElementById("layout-summary").textContent =
        `Manned tills: ${STORE_CONFIG.mannedTills} · Self-checkouts: ${STORE_CONFIG.selfCheckouts}`;

      document.querySelectorAll(".lane-chip").forEach(chip => {
        chip.addEventListener("click", () => switchLane(chip.dataset.lane));
      });

      document.getElementById("reset-btn").addEventListener("click", () => {
        resetLane(currentLaneId);
      });

      // Attach swipe listeners to main app container
      const appRoot = document.getElementById("app-root");
      appRoot.addEventListener("touchstart", handleTouchStart, { passive: true });
      appRoot.addEventListener("touchend", handleTouchEnd, { passive: true });

      switchLane(currentLaneId);

      setInterval(() => {
        const rec = loadStatus(currentLaneId);
        if (rec && rec.updatedAt) {
          document.getElementById("last-updated").textContent =
            formatTimeAgo(rec.updatedAt);
        }
      }, 30000);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
