<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>How Long Is The Line?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 18px;
      padding: 18px 18px 22px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      border: 1px solid #1e293b;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .store {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .pill {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      color: #bfdbfe;
      background: rgba(37, 99, 235, 0.12);
    }

    .layout-summary {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 10px;
    }

    /* Lane switcher */
    .lane-switcher {
      display: inline-flex;
      padding: 4px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      margin-bottom: 10px;
    }

    .lane-chip {
      font-size: 0.75rem;
      padding: 5px 9px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease;
      white-space: nowrap;
    }

    .lane-chip.active {
      background: rgba(37, 99, 235, 0.18);
      color: #e5e7eb;
    }

    /* Status card */
    .status-card {
      border-radius: 14px;
      padding: 12px 12px 14px;
      margin-bottom: 14px;
      background: radial-gradient(circle at top left, #1d2535, #020617);
      border: 1px solid #1f2937;
    }

    .status-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .status-value {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .dot-none { background: #22c55e; }
    .dot-short { background: #a3e635; }
    .dot-medium { background: #eab308; }
    .dot-long { background: #f97316; }

    /* Progress bar */
    .progress-wrapper {
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .progress-track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transition: width 0.18s ease;
    }

    .fill-none { background: #22c55e; }
    .fill-short { background: #a3e635; }
    .fill-medium { background: #eab308; }
    .fill-long { background: #f97316; }

    .meta {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 0.78rem;
      color: #6b7280;
    }

    /* Reset button */
    .reset-btn {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.12s ease, border 0.12s ease;
    }

    .reset-btn:hover {
      background: #1e293b;
      border-color: #334155;
    }

    .reset-btn:active {
      transform: scale(0.98);
    }

    /* Section buttons */
    .sections {
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .section-btn {
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      cursor: pointer;
      transition: border 0.12s ease, background 0.12s ease, transform 0.05s ease;
    }

    .section-btn .label {
      font-weight: 600;
      font-size: 0.82rem;
    }

    .section-btn .sub {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .section-btn:hover {
      border-color: #4b5563;
      background: #030712;
    }

    .section-btn:active {
      transform: scale(0.98);
    }

    .section-btn.selected {
      border-color: #2563eb;
      background: rgba(37, 99, 235, 0.16);
    }

    .hint {
      font-size: 0.75rem;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .app { padding: 16px; border-radius: 16px; }
      .lane-switcher { width: 100%; justify-content: space-between; }
      .lane-chip { flex: 1; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div>
        <div class="title">How long is the line?</div>
        <div class="store" id="store-name">ALDI Selly Oak</div>
      </div>
      <div class="pill">Live check-in</div>
    </header>

    <div class="layout-summary" id="layout-summary">
      Manned tills: 6 · Self-checkouts: 2
    </div>

    <div class="lane-switcher" id="lane-switcher">
      <button class="lane-chip active" data-lane="tills">Main tills</button>
      <button class="lane-chip" data-lane="sco1">Self-checkout 1</button>
      <button class="lane-chip" data-lane="sco2">Self-checkout 2</button>
    </div>

    <section class="status-card">
      <div class="status-label" id="lane-label">Current report · Main tills</div>
      <div class="status-value">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">No reports yet</span>
      </div>

      <div class="progress-wrapper">
        <div class="progress-track">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <div class="meta">
        <span id="last-updated">Last updated: —</span>
        <span id="local-only">Local votes on this device</span>
      </div>
    </section>

    <button id="reset-btn" class="reset-btn">Reset this lane</button>

    <section class="sections" id="sections">
      <!-- Buttons injected by JS -->
    </section>

    <p class="hint">
      Pick your lane, then tap a section.  
      The bar shows the average of all your taps for that lane.
    </p>
  </div>

  <script>
    // Store + lanes
    const STORE_CONFIG = {
      id: "aldi_selly_oak",
      name: "ALDI Selly Oak",
      mannedTills: 6,
      selfCheckouts: 2,
      lanes: [
        { id: "tills", label: "Main tills" },
        { id: "sco1", label: "Self-checkout 1" },
        { id: "sco2", label: "Self-checkout 2" }
      ]
    };

    // Per-lane sections
    const SECTION_CONFIG = {
      tills: [
        { id: "none", label: "No queue", description: "Walk straight up", fill: 5, intensity: "none" },
        { id: "front", label: "Front of aisle", description: "Just into aisle", fill: 25, intensity: "short" },
        { id: "middle", label: "Middle of aisle", description: "Halfway down", fill: 50, intensity: "medium" },
        { id: "back", label: "Back of aisle", description: "Near end", fill: 75, intensity: "long" },
        { id: "beyond", label: "Beyond aisle", description: "Wrapped/Outside", fill: 100, intensity: "long" }
      ],

      sco1: [
        { id: "sco_full", label: "Packed / long wait", description: "All machines busy", fill: 100, intensity: "long" },
        { id: "sco_tight", label: "No spaces, 1–3 waiting", description: "Small queue", fill: 70, intensity: "medium" },
        { id: "sco_some", label: "1–2 spaces free", description: "Probably get one", fill: 40, intensity: "short" },
        { id: "sco_plenty", label: "3+ spaces free", description: "Plenty of machines", fill: 15, intensity: "none" }
      ],

      sco2: [
        { id: "sco_full", label: "Packed / long wait", description: "All machines busy", fill: 100, intensity: "long" },
        { id: "sco_tight", label: "No spaces, 1–3 waiting", description: "Small queue", fill: 70, intensity: "medium" },
        { id: "sco_some", label: "1–2 spaces free", description: "Probably get one", fill: 40, intensity: "short" },
        { id: "sco_plenty", label: "3+ spaces free", description: "Plenty of machines", fill: 15, intensity: "none" }
      ]
    };

    const STORAGE_PREFIX = "queue_section_" + STORE_CONFIG.id + "_";
    let currentLaneId = "tills";

    const laneStorageKey = laneId => STORAGE_PREFIX + laneId;

    function loadStatus(laneId) {
      try {
        const raw = localStorage.getItem(laneStorageKey(laneId));
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj.votes) obj.votes = {};
        return obj;
      } catch { return null; }
    }

    function registerVote(laneId, sectionId) {
      const key = laneStorageKey(laneId);
      let record = loadStatus(laneId) || { votes: {} };

      record.votes[sectionId] = (record.votes[sectionId] || 0) + 1;
      record.updatedAt = new Date().toISOString();
      localStorage.setItem(key, JSON.stringify(record));
      return record;
    }

    function resetLane(laneId) {
      localStorage.removeItem(laneStorageKey(laneId));
      applyStatusToUI(laneId);
    }

    function formatTimeAgo(iso) {
      if (!iso) return "Last updated: —";
      const t = new Date(iso);
      const diff = (new Date() - t) / 60000;
      if (diff < 1) return "Last updated: just now";
      if (diff < 60) return `Last updated: ${Math.floor(diff)} minutes ago`;
      const h = diff / 60;
      if (h < 24) return `Last updated: ${Math.floor(h)} hours ago`;
      const d = h / 24;
      return `Last updated: ${Math.floor(d)} days ago`;
    }

    function getSectionsForLane(laneId) {
      return SECTION_CONFIG[laneId] || SECTION_CONFIG["tills"];
    }

    function renderSectionsForLane(laneId) {
      const box = document.getElementById("sections");
      box.innerHTML = "";
      getSectionsForLane(laneId).forEach(section => {
        const btn = document.createElement("button");
        btn.className = "section-btn";
        btn.dataset.section = section.id;

        btn.innerHTML = `
          <span class="label">${section.label}</span>
          <span class="sub">${section.description}</span>
        `;

        btn.addEventListener("click", () => {
          registerVote(currentLaneId, section.id);
          applyStatusToUI(currentLaneId);
        });

        box.appendChild(btn);
      });
    }

    function applyStatusToUI(laneId) {
      const record = loadStatus(laneId);
      const dot = document.getElementById("status-dot");
      const text = document.getElementById("status-text");
      const fillBar = document.getElementById("progress-fill");
      const updated = document.getElementById("last-updated");
      const label = document.getElementById("lane-label");

      label.textContent = `Current report · ${STORE_CONFIG.lanes.find(l => l.id === laneId).label}`;

      dot.className = "dot";
      fillBar.className = "progress-fill";
      fillBar.style.width = "0%";
      document.querySelectorAll(".section-btn").forEach(b => b.classList.remove("selected"));

      if (!record || !record.votes) {
        text.textContent = "No reports yet";
        updated.textContent = "Last updated: —";
        return;
      }

      const sections = getSectionsForLane(laneId);

      let total = 0, weighted = 0, top = null, topCount = 0;

      for (const s of sections) {
        const n = record.votes[s.id] || 0;
        if (n > 0) {
          total += n;
          weighted += n * s.fill;
          if (n > topCount) { top = s; topCount = n; }
        }
      }

      if (total === 0) {
        text.textContent = "No reports yet";
        updated.textContent = "Last updated: —";
        return;
      }

      const avg = weighted / total;

      // find closest section for label/intensity
      let closest = sections[0];
      let bestDiff = Math.abs(closest.fill - avg);
      for (const s of sections) {
        const d = Math.abs(s.fill - avg);
        if (d < bestDiff) { closest = s; bestDiff = d; }
      }

      text.textContent =
        laneId === "tills"
          ? `Queue around: ${closest.label} (${total} reports)`
          : `Self-checkout: ${closest.label} (${total} reports)`;

      dot.classList.add("dot-" + closest.intensity);
      fillBar.classList.add("fill-" + closest.intensity);
      fillBar.style.width = `${avg}%`;

      updated.textContent = formatTimeAgo(record.updatedAt);

      if (top) {
        const b = document.querySelector(`.section-btn[data-section="${top.id}"]`);
        if (b) b.classList.add("selected");
      }
    }

    function switchLane(id) {
      currentLaneId = id;
      document.querySelectorAll(".lane-chip").forEach(c =>
        c.classList.toggle("active", c.dataset.lane === id));
      renderSectionsForLane(id);
      applyStatusToUI(id);
    }

    function init() {
      document.getElementById("store-name").textContent = STORE_CONFIG.name;
      document.getElementById("layout-summary").textContent =
        `Manned tills: ${STORE_CONFIG.mannedTills} · Self-checkouts: ${STORE_CONFIG.selfCheckouts}`;

      document.querySelectorAll(".lane-chip").forEach(c =>
        c.addEventListener("click", () => switchLane(c.dataset.lane))
      );

      document.getElementById("reset-btn").addEventListener("click", () => {
        resetLane(currentLaneId);
      });

      switchLane(currentLaneId);

      setInterval(() => {
        const rec = loadStatus(currentLaneId);
        if (rec && rec.updatedAt) {
          document.getElementById("last-updated").textContent =
            formatTimeAgo(rec.updatedAt);
        }
      }, 30000);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
